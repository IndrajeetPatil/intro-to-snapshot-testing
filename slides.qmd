---
title: "Introduction to snapshot testing in R"
format:
  revealjs: 
    theme: simple
    slide-number: true
    preview-links: auto
    footer: "Source code for the slides can be found [here](https://github.com/IndrajeetPatil/intro-to-snapshot-testing)."
author: "Indrajeet Patil"
execute:
  echo: true
---

## Who is this for?

If you develop R packages and have wondered to yourself about how to 

::: incremental

- test that fancy printing prints as expected
- test that generated plots or images are as expected
- test that an entire file is as expected
- write maintainable tests when the output is too complex to include in the source code
- update such tests *en masse* 
- ...

::: 

<!-- ::: footer -->
<!-- Photo by Roman Mager on [Unsplash](https://unsplash.com/photos/5mZ_M06Fc9g) -->
<!-- ::: -->


# Testing print outputs

We will explore the ease with which snapshot tests can be used to check that printing methods work as expected.

Such custom methods are implemented to pretty-print R objects, to create visually pleasing warning/error messages, etc.

## Example function

Let's say we want to write a test for the following printing function in our R package:

::: panel-tabset

### Source code

```{r}
print_movies <- function(keys, values) {
  paste0(
    "Movie: \n",
    paste0("  ", keys, ": ", values, collapse = "\n")
  )
}
```

### Output

```{r}
cat(print_movies(
  c("Title", "Director"),
  c("Salaam Bombay!", "Mira Nair")
))
```

:::

## Example test {.smaller}

Even testing this simple function is a bit painful because we need to keep track of every escape character, every space, etc. 

```{r}
library(testthat)

test_that("`print_movies()` prints as expected", {
  expect_equal(
    print_movies(
      c("Title", "Director"),
      c("Salaam Bombay!", "Mira Nair")
    ),
    "Movie: \n  Title: Salaam Bombay!\n  Director: Mira Nair"
  )
})
```

With a more complicated output, it'd impossible for a human to read the expected output.

:::{.callout-important}

If this is a utility function used by many other functions, changing its behaviour would entail *manually changing* expected outputs for many tests.
This is not maintainable! ðŸ˜©

:::

## Alternative: Snapshot test! {.smaller}

Instead, you can use `expect_snapshot()`!

:::{.callout-note}
You will need to use `{testthat}` [third edition](https://testthat.r-lib.org/articles/third-edition.html).
:::

The first time you run the test, it would generate a Markdown file with expected output, and this will act as the expected output from the function.

```{r include = FALSE}
snapper <- local_snapshotter()
snapper$start_file("slides.qmd", "test")
```

```{r, error=TRUE}
test_that("`print_movies()` prints as expected", {
  local_edition(3)
  expect_snapshot(cat(print_movies(
    c("Title", "Director"),
    c("Salaam Bombay!", "Mira Nair")
  )))
})
```

```{r, include = FALSE}
# Reset snapshot test
snapper$end_file()
snapper$start_file("slides.qmd", "test")
```

# Self-study 

In this presentation, we deliberately kept the example and the tests simple. 

To study realistic usage of snapshot tests, you should explore some open-source test suits on your own. 

---

## Print outputs {.smaller}

- [`{cli}`](https://github.com/r-lib/cli/tree/main/tests/testthat) (for testing command line interfaces)

- [`{pkgdown}`](https://github.com/r-lib/pkgdown/tree/main/tests/testthat) (for testing generated HTML documents)

- [`{dbplyr}`](https://github.com/tidyverse/dbplyr/tree/main/tests/testthat) (for testing printing of generated SQL queries)

- [`{gt}`](https://github.com/rstudio/gt/tree/master/tests/testthat) (for testing table printing)

## Visualizations {.smaller}

- [`{ggplot2}`](https://github.com/tidyverse/ggplot2/tree/main/tests/testthat)

- [`{ggstatsplot}`](https://github.com/IndrajeetPatil/ggstatsplot/tree/main/tests/testthat)
